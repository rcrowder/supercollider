<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<title></title>
<meta name="Generator" content="Cocoa HTML Writer">
<meta name="CocoaVersion" content="824.42">
<style type="text/css">
p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 18.0px Helvetica}
p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Helvetica}
p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Helvetica; min-height: 17.0px}
p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; font: 9.0px Monaco}
p.p7 {margin: 0.0px 0.0px 0.0px 0.0px; font: 9.0px Monaco; min-height: 12.0px}
p.p8 {margin: 0.0px 0.0px 0.0px 0.0px; font: 9.0px Monaco; color: #792b21}
p.p9 {margin: 0.0px 0.0px 0.0px 0.0px; font: 9.0px Monaco; color: #0a33a2}
p.p10 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Monaco; min-height: 16.0px}
p.p11 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; color: #000000; min-height: 14.0px}
p.p12 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Helvetica; color: #000000}
p.p13 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; color: #000000}
p.p14 {margin: 0.0px 0.0px 0.0px 0.0px; font: 9.0px Monaco; color: #000000}
span.s1 {font: 12.0px Helvetica}
span.s2 {color: #526630}
span.s3 {color: #0a33a2}
span.s4 {color: #000000}
span.s5 {color: #792b21}
span.s6 {color: #556930}
span.s7 {color: #0000bf}
span.s8 {color: #606060}
span.Apple-tab-span {white-space:pre}
</style>
</head>
<body>
<p class="p1"><b>Environment</b></p>
<p class="p2"><br></p>
<p class="p3"><b>superclass: IdentityDictionary</b></p>
<p class="p3"><b>related classes: Event, IdentityDictionary</b></p>
<p class="p2"><br></p>
<p class="p3">An Environment is an IdentityDictionary with additional features that allow it to serve as a 'name space' within</p>
<p class="p3">which functions can be defined and/or evaluated.</p>
<p class="p2"><br></p>
<p class="p3"><b>PseudoVariables (global variables)</b></p>
<p class="p2"><br></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>currentEnvironment<span class="Apple-tab-span">	</span></b>determines environment used by "~" syntax, valueEnvir, and valueArrayEnvir</p>
<p class="p3"><b><span class="Apple-tab-span">	</span>topEnvironment<span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>initial value of currentEnvironment, can be used for 'global variables'</p>
<p class="p2"><br></p>
<p class="p3"><b>Class variables</b></p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span><b>stack</b></p>
<p class="p3"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>Maintains a stack of Environments accessed by <b>push </b>and <b>pop</b></p>
<p class="p2"><br></p>
<p class="p3"><b>Class methods</b></p>
<p class="p2"><br></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>*make(function)<span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>creates a new Environment and sends make message</p>
<p class="p3"><b><span class="Apple-tab-span">	</span>*use(function)<span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>creates a new Environment and sends use message</p>
<p class="p3"><b><span class="Apple-tab-span">	</span>*push<span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>saves currentEnvironment on the stack<span class="Apple-tab-span">	</span></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>*pop<span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>restores currentEnvironment from the stack</p>
<p class="p2"><br></p>
<p class="p3"><b>Methods</b></p>
<p class="p2"><br></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>make(function)</b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>evaluates the function within the environment, returns the environment.<span class="Apple-tab-span">	</span></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>use(function)<span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>evaluates the function within the environment, returns the return valus of the function.<span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span><b>push<span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>saves the receiver on the stack</p>
<p class="p3"><b><span class="Apple-tab-span">	</span>pop<span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>restores currentEnvironment from the stack</p>
<p class="p2"><br></p>
<p class="p3"><b>Related Messages</b></p>
<p class="p2"><br></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>valueEnvir (arg1, arg2...)<span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>evaluates a function, looking up unspecified arguments in <b>currentEnvironment</b></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>valueArrayEnvir (argArray)<span class="Apple-tab-span">	</span></b>same as valueEnvir, but with arguments in an array</p>
<p class="p2"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p2"><br></p>
<p class="p4"><b>Overview: topEnvironment, currentEnvironment, make and use</b></p>
<p class="p5"><br></p>
<p class="p2"><br></p>
<p class="p3">When SuperCollider starts, it creates an Environment that it stores in the pseudovariables<span class="Apple-converted-space"> </span></p>
<p class="p3"><b>topEnvironment </b>and <b>currentEnvironment</b>.<span class="Apple-converted-space">  </span>The <b>topEnvironment </b>provides a universally</p>
<p class="p3">accessible collection of named values<span class="Apple-converted-space">  </span>similar to the <b>Interpreter </b>variables a, b, c, ....</p>
<p class="p2"><br></p>
<p class="p3">The compiler provides a shortcut syntax where ~ is a placeholder for <b>currentEnvironment</b>.<span class="Apple-converted-space"> </span></p>
<p class="p3">This makes the expression</p>
<p class="p2"><br></p>
<p class="p6"><span class="Apple-tab-span">	</span>~myvariable;<span class="Apple-converted-space">  <span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></span><span class="s1">equivalent to <span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></span>currentEnvironment.at(\<span class="s2">myvariable</span>);</p>
<p class="p7"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p3">and the expression</p>
<p class="p2"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p6"><span class="s1"><span class="Apple-tab-span">	</span></span>~myvariable = 888;<span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="s1">equivalent to<span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></span>currentEnvironment.put(\<span class="s2">myvariable</span>, 888);</p>
<p class="p2"><br></p>
<p class="p3">The messages <b>make(function) </b>and <b>use(function) </b>replace currentEnvironment with the receiver. evaluate</p>
<p class="p3">the function and then restore currentEnvironment's original value.<span class="Apple-converted-space">  </span>The message <b>make</b> is intended</p>
<p class="p3">to be used when initializing an Environment, so it returns the Environment.<span class="Apple-converted-space">  </span>The message <b>use </b>is for</p>
<p class="p3">evaluating a functions within an Environment, so it returns the return value of the function.</p>
<p class="p2"><br></p>
<p class="p3">For example</p>
<p class="p6"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>(</p>
<p class="p6"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>a = <span class="s3">Environment</span>.make({</p>
<p class="p6"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>~a = 100;</p>
<p class="p6"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>~b = 200;</p>
<p class="p6"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>~c = 300;</p>
<p class="p6"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>});</p>
<p class="p6"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>a.postln;</p>
<p class="p6"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>)</p>
<p class="p3">creates an environment, while</p>
<p class="p2"><br></p>
<p class="p6"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>a.use({</p>
<p class="p6"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>~a + ~b + ~c</p>
<p class="p6"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>}).postln;</p>
<p class="p7"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p3">evaluates the function within that environment.</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p4"><b>valueEnvir and valueArrayEnvir</b></p>
<p class="p2"><br></p>
<p class="p3">When Functions are evaluated with <b>valueEnvir</b> and <b>valueArrayEnvir</b> unspecified arguments are looked up in the current Environment.</p>
<p class="p3">If the argument is not found in the Environment its default value is used.</p>
<p class="p2"><br></p>
<p class="p6">(</p>
<p class="p6"><span class="s3">var</span> f;</p>
<p class="p7"><br></p>
<p class="p8">// define a function</p>
<p class="p6">f = { <span class="s3">arg</span> x, y, z; [x, y, z].postln; };</p>
<p class="p7"><br></p>
<p class="p9">Environment<span class="s4">.use({</span></p>
<p class="p6"><span class="Apple-tab-span">	</span>~x = 7;</p>
<p class="p6"><span class="Apple-tab-span">	</span>~y = 8;</p>
<p class="p6"><span class="Apple-tab-span">	</span>~z = 9;</p>
<p class="p7"><span class="Apple-tab-span">	</span></p>
<p class="p6"><span class="Apple-tab-span">	</span>f.valueEnvir(1, 2, 3);<span class="Apple-tab-span">	</span><span class="s5">// all values supplied</span></p>
<p class="p8"><span class="s4"><span class="Apple-tab-span">	</span>f.valueEnvir(1, 2);<span class="Apple-tab-span">	</span></span>// z is looked up in the current Environment</p>
<p class="p8"><span class="s4"><span class="Apple-tab-span">	</span>f.valueEnvir(1);<span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></span>// y and z are looked up in the current Environment<span class="Apple-converted-space"> </span></p>
<p class="p8"><span class="s4"><span class="Apple-tab-span">	</span>f.valueEnvir;<span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></span>// all arguments are looked up in the current Environment</p>
<p class="p8"><span class="s4"><span class="Apple-tab-span">	</span>f.valueEnvir(z: 1);<span class="Apple-tab-span">	</span></span>// x and y are looked up in the current Environment</p>
<p class="p6">});</p>
<p class="p6">)</p>
<p class="p10"><br></p>
<p class="p3">Now here is how this can be used with an instrument function. Environments allow you to define instruments without having to worry about argument ordering conflicts. Even though the three functions below have the freq, amp and pan args declared in different orders it does not matter, because valueEnvir looks them up in the</p>
<p class="p3">environment.<span class="Apple-converted-space"> </span></p>
<p class="p2"><br></p>
<p class="p6">s.boot;</p>
<p class="p7"><br></p>
<p class="p6">(</p>
<p class="p6"><span class="s3">var</span> orc;</p>
<p class="p6">orc = Environment.make {</p>
<p class="p6"><span class="Apple-tab-span">	</span>~a = { <span class="s3">arg</span> freq, amp, pan;</p>
<p class="p6"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="s3">Pan2</span>.ar(<span class="s3">SinOsc</span>.ar(freq), pan, amp);</p>
<p class="p6"><span class="Apple-tab-span">	</span>};</p>
<p class="p6"><span class="Apple-tab-span">	</span>~b =<span class="Apple-converted-space">  </span>{ <span class="s3">arg</span> amp, pan, freq;</p>
<p class="p6"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="s3">Pan2</span>.ar(<span class="s3">RLPF</span>.ar(<span class="s3">Saw</span>.ar(freq), freq * 6, 0.1), pan, amp);</p>
<p class="p6"><span class="Apple-tab-span">	</span>};</p>
<p class="p6"><span class="Apple-tab-span">	</span>~c =<span class="Apple-converted-space">  </span>{ <span class="s3">arg</span> pan, freq, amp;</p>
<p class="p6"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="s3">Pan2</span>.ar(<span class="s3">Resonz</span>.ar(<span class="s3">GrayNoise</span>.ar, freq * 2, 0.1), pan, amp * 2);</p>
<p class="p6"><span class="Apple-tab-span">	</span>};</p>
<p class="p6"><span class="Apple-tab-span">	</span>~orc = [~a, ~b, ~c];</p>
<p class="p6">};</p>
<p class="p8">// 'reverb'</p>
<p class="p6">{ <span class="s3">var</span> in; in = <span class="s3">In</span>.ar(0, 2); <span class="s3">CombN</span>.ar(in, 0.2, 0.2, 3, 1, in); }.play(addAction: <span class="s6">\addToTail</span>);</p>
<p class="p7"><br></p>
<p class="p6">{ loop({</p>
<p class="p6"><span class="Apple-tab-span">	</span><span class="s3">orc</span>.use({</p>
<p class="p8"><span class="s4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></span>// set values in the environment</p>
<p class="p6"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>~freq = exprand(80, 600);</p>
<p class="p6"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>~amp = 0.1;</p>
<p class="p6"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>~pan = 1.0.rand2;</p>
<p class="p7"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p8"><span class="s4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></span>// call a randomly chosen instrument function<span class="Apple-converted-space"> </span></p>
<p class="p8"><span class="s4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></span>// with values from the environment</p>
<p class="p7"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p6"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span> x = { ~orc.choose.valueEnvir; }.play(fadeTime: 0.2, addAction: <span class="s6">\addToHead</span>);<span class="Apple-converted-space"> </span></p>
<p class="p6"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span> 0.2.wait;<span class="Apple-converted-space"> </span></p>
<p class="p6"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span> x.release(0.2);<span class="Apple-converted-space"> </span></p>
<p class="p6"><span class="Apple-tab-span">	</span>});</p>
<p class="p6">}) }.fork;</p>
<p class="p7"><span class="Apple-tab-span">	</span></p>
<p class="p6">)</p>
<p class="p7"><br></p>
<p class="p11"><br></p>
<p class="p12"><b>Environments and asynchronous functions</b></p>
<p class="p11"><br></p>
<p class="p13">Local variables declared in functions, and class and instance variables, use lexical scope. That is, the context in which they are understood depends on where the declaration is read during compilation. Asynchronous functions -- any function that will execute outside (later than) the current execution flow -- carry their lexically scoped variables with them.</p>
<p class="p11"><br></p>
<p class="p14">f = { <span class="s7">var</span> a = <span class="s8">"got it"</span>; { a.postln }.defer(0.5) };</p>
<p class="p14">f.value;</p>
<p class="p11"><br></p>
<p class="p13">Asynchronous functions include any scheduled function, responder function associated with OSCresponder, MIDIResponder, HID or GUI action functions, or actions used in server messaging (such as Buffer.read, Buffer or Bus .get, and so on).</p>
<p class="p11"><br></p>
<p class="p13">Environment variables have dynamic scope; they are read from whichever environment is current, whether or not it was the current environment when the function was declared. For instance, the following fails because e is no longer the current environment when the deferred function wakes up.</p>
<p class="p11"><br></p>
<p class="p14">e = (a: <span class="s8">"got it"</span>, f: { { ~a.postln }.defer(0.5) });</p>
<p class="p14">e.use { e.f };</p>
<p class="p11"><br></p>
<p class="p13">Function's inEnvir method attaches a function to a specific environment. If no environment is given, the current environment at the time of executing inEnvir is the default.</p>
<p class="p11"><br></p>
<p class="p14">e = (a: <span class="s8">"got it"</span>, f: { { ~a.postln }.inEnvir.defer(0.5) });</p>
<p class="p14">e.use { e.f };</p>
</body>
</html>
