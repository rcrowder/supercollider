<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<title></title>
<meta name="Generator" content="Cocoa HTML Writer">
<meta name="CocoaVersion" content="824.42">
<style type="text/css">
p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 18.0px Helvetica}
p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 9.0px Monaco; min-height: 12.0px}
p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 10.0px Monaco; color: #264cd6}
p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; color: #001fe8}
p.p7 {margin: 0.0px 0.0px 0.0px 0.0px; font: 9.0px Monaco; color: #902f20}
p.p8 {margin: 0.0px 0.0px 0.0px 0.0px; font: 9.0px Monaco}
p.p9 {margin: 0.0px 0.0px 0.0px 0.0px; font: 9.0px Monaco; color: #606060}
p.p10 {margin: 0.0px 0.0px 0.0px 0.0px; font: 9.0px Monaco; color: #653928}
p.p11 {margin: 0.0px 0.0px 0.0px 0.0px; font: 9.0px Monaco; color: #000000; min-height: 12.0px}
p.p12 {margin: 0.0px 0.0px 0.0px 0.0px; font: 9.0px Monaco; color: #bf0000}
p.p13 {margin: 0.0px 0.0px 0.0px 0.0px; font: 9.0px Monaco; color: #000000}
span.s1 {color: #5b633c}
span.s2 {text-decoration: underline}
span.s3 {color: #000000}
span.s4 {color: #062cb0}
span.s5 {color: #606060}
span.s6 {color: #45691f}
span.s7 {color: #16359f}
span.s8 {color: #0000bf}
span.Apple-tab-span {white-space:pre}
</style>
</head>
<body>
<p class="p1"><b>Convolution2<span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>real-time convolver</b></p>
<p class="p2"><br></p>
<p class="p3"><b>Convolution2.ar(in, bufnum, trigger, framesize, mul, add)</b></p>
<p class="p2"><br></p>
<p class="p3">Strict convolution with fixed kernel which can be updated using a trigger signal.</p>
<p class="p4"><br></p>
<p class="p5"><span class="s1">//see ch18 </span><span class="s2">http://www.dspguide.com/ch18.htm</span><span class="s1"> Steven W Smith</span></p>
<p class="p4"><br></p>
<p class="p3"><b>in</b> - processing target</p>
<p class="p3"><b>bufnum</b> - buffer index for the fixed kernel, may be modulated in combination with the trigger</p>
<p class="p3"><b>trigger</b> - update the kernel on a change from &lt;=0 to &gt;0</p>
<p class="p3"><b>framesize </b>- size of FFT frame, must be a power of two. Convolution uses twice this number internally, maximum value you can give this argument is 2^16=65536. Note that it gets progressively more expensive to run for higher powers! 512, 1024, 2048, 4096 standard.</p>
<p class="p4"><br></p>
<p class="p6"><span class="s3">See also <a href="Convolution2L.html"><span class="s2">Convolution2L</span></a>.</span></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p7"><span class="s3">(</span>//allocate three buffers</p>
<p class="p8">b = <span class="s4">Buffer</span>.alloc(s,2048);</p>
<p class="p8">c = <span class="s4">Buffer</span>.alloc(s,2048);</p>
<p class="p8">d = <span class="s4">Buffer</span>.alloc(s,2048);</p>
<p class="p2"><br></p>
<p class="p8">b.zero;</p>
<p class="p8">c.zero;</p>
<p class="p8">d.zero;</p>
<p class="p8">)</p>
<p class="p2"><br></p>
<p class="p8">(</p>
<p class="p8">50.do({ <span class="s4">|it|</span> c.set(20*it+10, 1.0.rand); });</p>
<p class="p8">3.do({ <span class="s4">|it|</span> b.set(400*it+100, 1); });</p>
<p class="p8">20.do({ <span class="s4">|it|</span> d.set(40*it+20, 1); });</p>
<p class="p8">)</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p8">(</p>
<p class="p8"><span class="s4">SynthDef</span>( <span class="s5">"conv-test"</span>, { <span class="s4">arg</span> kernel, t_trig=0;</p>
<p class="p8"><span class="Apple-tab-span">	</span><span class="s4">var</span> input;</p>
<p class="p2"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p8"><span class="Apple-tab-span">	</span>input=<span class="s4">Impulse</span>.ar(1);</p>
<p class="p2"><br></p>
<p class="p7"><span class="s3"><span class="Apple-tab-span">	</span></span>//must have power of two framesize</p>
<p class="p8"><span class="Apple-tab-span">	</span><span class="s4">Out</span>.ar(0,<span class="s4">Convolution2</span>.ar(input,kernel,t_trig,2048, 0.5));</p>
<p class="p8">}).send(s)</p>
<p class="p2"><br></p>
<p class="p8">)</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p8">x = <span class="s4">Synth</span>.new(<span class="s5">"conv-test"</span>,[<span class="s6">\kernel</span>,b]);</p>
<p class="p2"><br></p>
<p class="p7">// changing the buffer number:</p>
<p class="p8">x.set(<span class="s6">\kernel</span>,c);</p>
<p class="p7"><span class="s3">x.set(</span><span class="s6">\t_trig</span><span class="s3">,1); </span>// after this trigger, the change will take effect.</p>
<p class="p8">x.set(<span class="s6">\kernel</span>,d);</p>
<p class="p7"><span class="s3">x.set(</span><span class="s6">\t_trig</span><span class="s3">,1); </span>// after this trigger, the change will take effect.</p>
<p class="p2"><br></p>
<p class="p8">d.zero;</p>
<p class="p7"><span class="s3">40.do({ </span><span class="s4">|it|</span><span class="s3"> d.set(20*it+10, 1); });</span>// changing the buffers' contents</p>
<p class="p7"><span class="s3">x.set(</span><span class="s6">\t_trig</span><span class="s3">,1); </span>// after this trigger, the change will take effect.</p>
<p class="p2"><br></p>
<p class="p8">x.set(<span class="s6">\kernel</span>,b);</p>
<p class="p7"><span class="s3">x.set(</span><span class="s6">\t_trig</span><span class="s3">,1); </span>// after this trigger, the change will take effect.</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p7">////next example</p>
<p class="p2"><br></p>
<p class="p9"><span class="s3">b = </span><span class="s4">Buffer</span><span class="s3">.read(s,</span>"sounds/a11wlk01.wav"<span class="s3">);</span></p>
<p class="p2"><br></p>
<p class="p8">(</p>
<p class="p8"><span class="Apple-tab-span">	</span>{ <span class="s4">var</span> input, kernel;</p>
<p class="p2"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p8"><span class="Apple-tab-span">	</span>input= <span class="s4">SoundIn</span>.ar(0);</p>
<p class="p2"><br></p>
<p class="p7"><span class="s3"><span class="Apple-tab-span">	</span></span>//must have power of two framesize</p>
<p class="p8"><span class="Apple-tab-span">	</span><span class="s4">Out</span>.ar(0,<span class="s4">Convolution2</span>.ar(input,b,0,512, 0.5));</p>
<p class="p8"><span class="Apple-tab-span">	</span> }.play;</p>
<p class="p2"><br></p>
<p class="p8">)</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p7">//another example</p>
<p class="p2"><br></p>
<p class="p8">(</p>
<p class="p7">//must have power of two framesize- FFT size will be sorted by Convolution2 to be double this</p>
<p class="p7">//maximum is currently a=8192 for FFT of size 16384</p>
<p class="p8">a=2048;</p>
<p class="p8">s = <span class="s4">Server</span>.local;<span class="Apple-converted-space"> </span></p>
<p class="p7">//kernel buffer</p>
<p class="p8">g = <span class="s4">Buffer</span>.alloc(s,a,1);</p>
<p class="p8">)</p>
<p class="p2"><br></p>
<p class="p8">(</p>
<p class="p8">g.set(0,1.0);</p>
<p class="p8">100.do({<span class="s7">arg</span> i; g.set(a.rand, (i+1).reciprocal)});</p>
<p class="p8">)</p>
<p class="p2"><br></p>
<p class="p8">(</p>
<p class="p10">//random impulse response</p>
<p class="p2"><br></p>
<p class="p8"><span class="Apple-tab-span">	</span>{</p>
<p class="p8"><span class="Apple-tab-span">	</span><span class="s7">var</span> input,inputAmp,threshhold,gate;</p>
<p class="p2"><br></p>
<p class="p8">input = <span class="s7">AudioIn</span>.ar(1);<span class="Apple-converted-space"> </span></p>
<p class="p8">inputAmp = <span class="s7">Amplitude</span>.kr(input);</p>
<p class="p10"><span class="s3">threshhold = 0.02;<span class="Apple-tab-span">	</span></span>// noise gating threshold</p>
<p class="p8">gate = <span class="s7">Lag</span>.kr(inputAmp &gt; threshhold, 0.01);<span class="Apple-tab-span">	</span></p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p8"><span class="Apple-tab-span">	</span><span class="s7">Out</span>.ar(0,<span class="s7">Convolution2</span>.ar(input*gate,g,0, a, 0.5));</p>
<p class="p8"><span class="Apple-tab-span">	</span> }.play;</p>
<p class="p2"><br></p>
<p class="p8">)</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p11"><br></p>
<p class="p11"><br></p>
<p class="p12">//one last example</p>
<p class="p13">(</p>
<p class="p13">b = <span class="s8">Buffer</span>.alloc(s, 512, 1);</p>
<p class="p13">b.sine1(1.0/[1,2,3,4,5,6], <span class="s8">true</span>, <span class="s8">true</span>, <span class="s8">true</span>);</p>
<p class="p13">)</p>
<p class="p11"><br></p>
<p class="p13">(</p>
<p class="p13"><span class="Apple-tab-span">	</span>{ <span class="s8">var</span> input, kernel;</p>
<p class="p11"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p13"><span class="Apple-tab-span">	</span>input=<span class="s8">AudioIn</span>.ar(1);</p>
<p class="p11"><br></p>
<p class="p12"><span class="s3"><span class="Apple-tab-span">	</span></span>//must have power of two framesize</p>
<p class="p13"><span class="Apple-tab-span">	</span><span class="s8">Out</span>.ar(0,<span class="s8">Convolution2</span>.ar(input,b,0, 512, 0.5));</p>
<p class="p13"><span class="Apple-tab-span">	</span> }.play;</p>
<p class="p11"><br></p>
<p class="p13">)</p>
<p class="p11"><br></p>
</body>
</html>
